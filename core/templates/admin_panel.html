{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="flex flex-col md:flex-row max-w-full mx-auto h-[calc(100vh-4rem)]">

  <!-- SIDEBAR -->
  <aside class="bg-slate-900/90 border-r border-slate-800 p-4 flex flex-col md:w-64 w-full md:h-auto md:flex-shrink-0">
    <div class="flex justify-between items-center md:block mb-4">
      <h2 class="text-xl font-bold text-cyan-400">Админ-панель</h2>
      <button id="sidebar-toggle" class="md:hidden bg-slate-800 p-2 rounded text-slate-100">☰</button>
    </div>
    <nav id="sidebar-menu" class="flex flex-col gap-2 text-slate-100 md:block hidden md:block">
      <button class="admin-menu-item hover:bg-slate-800/60 px-3 py-2 rounded text-left" data-entity="users">Пользователи</button>
      <button class="admin-menu-item hover:bg-slate-800/60 px-3 py-2 rounded text-left" data-entity="courses">Курсы</button>
      <button class="admin-menu-item hover:bg-slate-800/60 px-3 py-2 rounded text-left" data-entity="lessons">Уроки</button>
      <button class="admin-menu-item hover:bg-slate-800/60 px-3 py-2 rounded text-left" data-entity="groups">Группы</button>
      <button class="admin-menu-item hover:bg-slate-800/60 px-3 py-2 rounded text-left" data-entity="journal">Журналы</button>
      <button class="admin-menu-item hover:bg-slate-800/60 px-3 py-2 rounded text-left" data-entity="applications">Заявки</button>
      <button class="admin-menu-item hover:bg-slate-800/60 px-3 py-2 rounded text-left" data-entity="videos">Видео</button>
      <button class="admin-menu-item hover:bg-slate-800/60 px-3 py-2 rounded text-left" data-entity="certificates">Сертификаты</button>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="flex-1 p-4 md:p-6 overflow-auto">

    <!-- LOGIN FORM -->
    <div id="admin-login" class="p-4 bg-slate-800 rounded mb-4">
      <h1 class="text-cyan-400 font-bold mb-2">Вход администратора</h1>
      <div class="flex flex-col md:flex-row gap-2">
        <input id="admin-username" placeholder="Username" class="px-2 py-1 rounded flex-1">
        <input id="admin-password" type="password" placeholder="Password" class="px-2 py-1 rounded flex-1">
        <button onclick="adminLogin()" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-1 rounded">Войти</button>
      </div>
    </div>

    <!-- ADMIN CONTENT -->
    <div id="admin-content" style="display:none;">
      <!-- Header -->
      <div class="flex justify-between items-center mb-4 md:mb-6 flex-wrap">
        <h1 id="admin-title" class="text-xl md:text-2xl font-bold text-cyan-400 mb-2 md:mb-0">Пользователи</h1>
        <button onclick="openAddModal()"
          class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded shadow whitespace-nowrap">Добавить</button>
      </div>

      <!-- Search & Filters -->
      <div class="flex flex-col md:flex-row gap-2 md:gap-4 mb-4">
        <input id="search-input" type="text" placeholder="Поиск..."
          class="px-3 py-2 rounded bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-cyan-400 flex-1">
        <select id="filter-role" class="px-3 py-2 rounded bg-slate-800 border border-slate-700 focus:outline-none focus:ring-2 focus:ring-cyan-400 md:w-40">
          <option value="">Все</option>
          <option value="staff">Staff</option>
          <option value="active">Active</option>
        </select>
      </div>

      <!-- Table -->
      <div class="overflow-x-auto bg-slate-900/80 rounded-xl border border-slate-800 shadow-lg">
        <table class="min-w-full divide-y divide-slate-700 text-sm">
          <thead class="bg-slate-800">
            <tr id="table-head"></tr>
          </thead>
          <tbody id="table-body" class="divide-y divide-slate-700"></tbody>
        </table>
      </div>
    </div>

  </main>

</div>

<!-- Modal -->
<div id="modal" class="hidden fixed inset-0 bg-black/50 flex justify-center items-center z-50 px-2">
  <div class="bg-slate-900 p-6 rounded-xl w-full max-w-md relative shadow-xl">
    <h2 id="modal-title" class="text-xl font-bold text-cyan-400 mb-4">Добавить</h2>
    <div id="modal-content" class="space-y-3"></div>
    <div class="flex justify-end gap-3 mt-4 flex-wrap">
      <button onclick="saveEntity()" class="bg-cyan-500 hover:bg-cyan-600 text-white px-4 py-2 rounded flex-1 md:flex-none">Сохранить</button>
      <button onclick="closeModal()" class="bg-slate-700 hover:bg-slate-800 text-white px-4 py-2 rounded flex-1 md:flex-none">Отмена</button>
    </div>
  </div>
</div>

<script>
<script>
// ===== SIDEBAR =====
const sidebarToggle = document.getElementById('sidebar-toggle');
const sidebarMenu = document.getElementById('sidebar-menu');

// ===== GLOBAL VARIABLES =====
let currentEntity = "users";
let data = [];
const tableHead = document.getElementById("table-head");
const tableBody = document.getElementById("table-body");
const modal = document.getElementById("modal");
const modalTitle = document.getElementById("modal-title");
const modalContent = document.getElementById("modal-content");
const searchInput = document.getElementById("search-input");
const adminLoginForm = document.getElementById('admin-login');
const adminContent = document.querySelector('main'); // контент до логина скрываем

// ===== SIDEBAR TOGGLE =====
sidebarToggle?.addEventListener('click', ()=> sidebarMenu.classList.toggle('hidden'));

// ===== TOKEN CHECK =====
function getToken() { return localStorage.getItem('admin_token'); }
function isLoggedIn() { return !!getToken(); }

// ===== LOGIN =====
async function adminLogin(){
    const username = document.getElementById('admin-username').value;
    const password = document.getElementById('admin-password').value;
    try {
        const res = await fetch('/api/token/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ username, password })
        });
        if(res.ok){
            const data = await res.json();
            localStorage.setItem('admin_token', data.access);
            adminLoginForm.style.display = 'none';
            adminContent.style.display = 'block';
            setupMenuClicks();
            fetchData();
        } else alert('Ошибка входа!');
    } catch(e) { console.error(e); alert('Ошибка сети!'); }
}

// ===== API URL =====
function getApiUrl(entity){
    const adminEntities = ['users','applications'];
    if(adminEntities.includes(entity)) return `/api/admin/${entity}/`;
    return `/api/${entity}/`;
}

// ===== FETCH DATA =====
async function fetchData(){
    if(!isLoggedIn()) return;
    try {
        const res = await fetch(getApiUrl(currentEntity), {
            headers: { 'Authorization': `Bearer ${getToken()}` }
        });
        if(res.ok){
            data = await res.json();
            renderTable();
        }
    } catch(e){ console.error(e); }
}

// ===== RENDER TABLE =====
function renderTable(){
    tableHead.innerHTML = "";
    tableBody.innerHTML = "";
    if(data.length===0){ tableHead.innerHTML="<th class='px-4 py-2'>Нет данных</th>"; return; }

    const keys = Object.keys(data[0]);
    const trHead = document.createElement("tr");
    keys.forEach(k=>{
        const th = document.createElement("th");
        th.innerText = k.charAt(0).toUpperCase() + k.slice(1);
        th.className = "px-4 py-2 text-left";
        trHead.appendChild(th);
    });
    const thAction = document.createElement("th");
    thAction.innerText = "Действия";
    thAction.className = "px-4 py-2";
    trHead.appendChild(thAction);
    tableHead.appendChild(trHead);

    data.forEach(item=>{
        const tr = document.createElement("tr");
        keys.forEach(k=>{
            const td = document.createElement("td");
            td.innerText = item[k];
            td.className = "px-4 py-2";
            tr.appendChild(td);
        });
        const tdAction = document.createElement("td");
        tdAction.className = "px-4 py-2 flex gap-2";
        const editBtn = document.createElement("button");
        editBtn.innerText = "Редактировать";
        editBtn.className = "bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs";
        editBtn.onclick = ()=> openEditModal(item);
        const delBtn = document.createElement("button");
        delBtn.innerText = "Удалить";
        delBtn.className = "bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs";
        delBtn.onclick = ()=> deleteItem(item.id);
        tdAction.appendChild(editBtn);
        tdAction.appendChild(delBtn);
        tr.appendChild(tdAction);
        tableBody.appendChild(tr);
    });
}

// ===== MODAL / FORM =====
function openAddModal(){ modalTitle.innerText=`Добавить ${currentEntity}`; modalContent.innerHTML=generateForm({}); modal.classList.remove("hidden"); }
function openEditModal(item){ modalTitle.innerText=`Редактировать ${currentEntity}`; modalContent.innerHTML=generateForm(item); modal.classList.remove("hidden"); }
function closeModal(){ modal.classList.add("hidden"); }
function generateForm(item){
    let html='';
    for(const key in item){
        html += `<div><label class="block text-sm text-slate-200">${key}</label><input type="text" name="${key}" value="${item[key]}" class="w-full px-2 py-1 rounded bg-slate-800 border border-slate-700 text-white"></div>`;
    }
    if(Object.keys(item).length===0){
        html += `<div><label class="block text-sm text-slate-200">Название</label><input type="text" name="name" value="" class="w-full px-2 py-1 rounded bg-slate-800 border border-slate-700 text-white"></div>`;
    }
    return html;
}

// ===== SAVE / DELETE =====
async function saveEntity(){
    const inputs = modalContent.querySelectorAll("input");
    let body={};
    inputs.forEach(i=>body[i.name]=i.value);
    const method = body.id?"PUT":"POST";
    const url = getApiUrl(currentEntity)+(body.id?body.id+"/":"");
    try{
        const res = await fetch(url,{
            method: method,
            headers: { "Content-Type":"application/json", "Authorization": `Bearer ${getToken()}` },
            body: JSON.stringify(body)
        });
        if(res.ok){ closeModal(); fetchData(); } else alert("Ошибка сохранения");
    } catch(e){ console.error(e); }
}

async function deleteItem(id){
    if(!confirm("Удалить запись?")) return;
    try{
        const res = await fetch(getApiUrl(currentEntity)+id+"/",{
            method:"DELETE",
            headers:{ "Authorization": `Bearer ${getToken()}` }
        });
        if(res.ok) fetchData();
    } catch(e){ console.error(e); }
}

// ===== SEARCH =====
searchInput?.addEventListener("input", ()=>{
    const q = searchInput.value.toLowerCase();
    const filtered = data.filter(d=>Object.values(d).some(v=>v.toString().toLowerCase().includes(q)));
    tableBody.innerHTML="";
    filtered.forEach(item=>{
        const tr=document.createElement("tr");
        Object.keys(item).forEach(k=>{
            const td=document.createElement("td");
            td.innerText=item[k];
            td.className="px-4 py-2";
            tr.appendChild(td);
        });
        const tdAction=document.createElement("td");
        tdAction.className="px-4 py-2 flex gap-2";
        const editBtn=document.createElement("button");
        editBtn.innerText="Редактировать";
        editBtn.className="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs";
        editBtn.onclick=()=>openEditModal(item);
        const delBtn=document.createElement("button");
        delBtn.innerText="Удалить";
        delBtn.className="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs";
        delBtn.onclick=()=>deleteItem(item.id);
        tdAction.appendChild(editBtn);
        tdAction.appendChild(delBtn);
        tr.appendChild(tdAction);
        tableBody.appendChild(tr);
    });
});

// ===== MENU CLICK AFTER LOGIN =====
function setupMenuClicks(){
    document.querySelectorAll(".admin-menu-item").forEach(btn=>{
        btn.addEventListener("click", ()=>{
            currentEntity = btn.dataset.entity;
            document.getElementById("admin-title").innerText = btn.innerText;
            fetchData();
            if(window.innerWidth < 768) sidebarMenu.classList.add("hidden");
        });
    });
}

// ===== INITIAL LOAD =====
if(isLoggedIn()){
    adminLoginForm.style.display='none';
    adminContent.style.display='block';
    setupMenuClicks();
    fetchData();
}else{
    adminContent.style.display='none';
}
</script>

{% endblock %}
