{% extends "base.html" %}
{% block content %}
<section class="space-y-8">
  <!-- Профиль -->
  <div id="teacher-card" class="card flex flex-col md:flex-row items-center gap-6">
    <div class="animate-pulse w-full flex gap-4 items-center">
      <div class="w-24 h-24 rounded-full bg-slate-800"></div>
      <div class="space-y-3 flex-1">
        <div class="h-5 bg-slate-800 rounded w-1/2"></div>
        <div class="h-4 bg-slate-800 rounded w-3/4"></div>
        <div class="h-4 bg-slate-800 rounded w-1/3"></div>
      </div>
    </div>
  </div>

  <!-- Курсы -->
  <div class="space-y-3">
    <h3 class="text-xl font-semibold">Мои курсы</h3>
    <div class="grid md:grid-cols-3 gap-4">
      <div class="card space-y-2">
        <h4 class="font-semibold text-lg">Python для начинающих</h4>
        <p class="text-slate-300 text-sm">20 учеников · прогресс 60%</p>
        <a href="#" class="btn-primary text-sm px-3 py-2 sm:w-auto justify-center">Перейти</a>
      </div>
      <div class="card space-y-2">
        <h4 class="font-semibold text-lg">Web-разработка</h4>
        <p class="text-slate-300 text-sm">15 учеников · прогресс 45%</p>
        <a href="#" class="btn-primary text-sm px-3 py-2 sm:w-auto justify-center">Перейти</a>
      </div>
    </div>
  </div>

  <!-- Группы и добавление студента -->
  <div class="space-y-3">
    <div class="flex items-center justify-between flex-wrap gap-3">
      <div class="flex items-center gap-2">
        <h3 class="text-xl font-semibold">Мои группы</h3>
        <a id="add-student-page" class="text-sm px-3 py-2 rounded-lg border border-slate-700 hover:border-cyan-400 transition" href="#">+ Студент</a>
      </div>
      <div class="flex flex-wrap gap-2">
      </div>
    </div>
    <div id="groups-list" class="grid md:grid-cols-2 gap-4"></div>
  </div>

  <!-- Журнал группы -->
  <div class="space-y-3">
    <h3 class="text-xl font-semibold">Журнал группы</h3>
    <a id="journal-link" class="inline-flex items-center gap-2 text-sm px-4 py-2 rounded-lg border border-slate-700 hover:border-cyan-400 transition w-full sm:w-auto" href="#">Открыть журналы</a>
    <div class="table-surface overflow-x-auto">
      <table class="min-w-full table-auto border-collapse">
        <thead>
          <tr>
            <th class="px-4 py-3 text-left border-b">Имя</th>
            <th class="px-4 py-3 text-left border-b">Курс</th>
            <th class="px-4 py-3 text-left border-b">Прогресс</th>
            <th class="px-4 py-3 text-left border-b">Статус</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-slate-800">
          <tr>
            <td class="px-4 py-3">Алексей</td>
            <td class="px-4 py-3">Python</td>
            <td class="px-4 py-3">70%</td>
            <td class="px-4 py-3 text-emerald-400 font-semibold">Активен</td>
          </tr>
          <tr>
            <td class="px-4 py-3">Мария</td>
            <td class="px-4 py-3">Web</td>
            <td class="px-4 py-3">50%</td>
            <td class="px-4 py-3 text-amber-300 font-semibold">В процессе</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>

<script>
  const card = document.getElementById('teacher-card');
  const pathParts = location.pathname.split('/').filter(Boolean);
  const maybeId = pathParts[pathParts.length - 1];
  const teacherId = Number.isInteger(Number(maybeId)) ? Number(maybeId) : null;
  const journalLink = document.getElementById('journal-link');
  const addStudentPageLink = document.getElementById('add-student-page');
  const groupsList = document.getElementById('groups-list');
  const groupNameInput = document.getElementById('group-name');
  const studentIdInput = document.getElementById('student-id');
  const createGroupBtn = document.getElementById('create-group');

  function renderTeacher(data){
    const user = data.user || {};
    const fullName = [user.first_name, user.last_name].filter(Boolean).join(' ') || user.username || 'Учитель';
    const bio = data.bio || 'Преподаватель';
    const phone = data.phone || '—';
    card.innerHTML = `
      <img src="/static/teacher.jpg" alt="Учитель" class="w-24 h-24 rounded-full shadow-lg border border-slate-700">
      <div class="space-y-2 flex-1">
        <h2 class="text-2xl font-bold">${fullName}</h2>
        <p class="text-slate-300">${bio}</p>
        <div class="flex flex-wrap gap-3 text-sm">
          <span class="px-3 py-1 rounded-full bg-emerald-500/90 text-emerald-950 font-semibold">ID ${data.id}</span>
          <span class="px-3 py-1 rounded-full bg-cyan-500/90 text-cyan-950 font-semibold">Телефон: ${phone}</span>
        </div>
      </div>
    `;
    if (journalLink && data.id) {
      journalLink.href = `/teacher_profile/${data.id}/journal/`;
    }
    if (addStudentPageLink && data.id) {
      addStudentPageLink.href = `/teacher_profile/${data.id}/add_student/`;
    }
  }

  async function loadTeacher() {
    try {
      if (!teacherId) {
        // fallback: взять первого учителя
        const listResp = await fetch('/api/teachers/');
        if (!listResp.ok) throw new Error('Не удалось загрузить список учителей');
        const list = await listResp.json();
        if (!list.length) throw new Error('Учителя не найдены');
        return renderTeacher(list[0]);
      }
      const resp = await fetch('/api/teachers/' + teacherId + '/');
      if (!resp.ok) throw new Error('Учитель не найден');
      const data = await resp.json();
      renderTeacher(data);
      loadGroups(data.id);
    } catch (e) {
      card.innerHTML = `<div class="text-red-300">Ошибка: ${e.message}</div>`;
    }
  }

  async function loadGroups(tId){
    try{
      const resp = await fetch('/api/groups/');
      if(!resp.ok) throw new Error('Не удалось загрузить группы');
      const data = await resp.json();
      const mine = data.filter(g => g.teacher && g.teacher.id === tId);
      if(!mine.length){
        groupsList.innerHTML = `<div class="text-slate-400 text-sm">Нет групп</div>`;
        return;
      }
      groupsList.innerHTML = mine.map(g => `
        <div class="card space-y-2">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-lg">${g.name}</h4>
            <span class="text-xs text-slate-400">#${g.id}</span>
          </div>
          <p class="text-slate-300 text-sm">Студентов: ${g.students.length}</p>
          <div class="flex flex-wrap gap-2 text-sm">
            ${g.students.map(s=>`<span class="px-2 py-1 rounded bg-slate-800 border border-slate-700">${s}</span>`).join('')}
          </div>
        </div>
      `).join('');
    }catch(e){
      groupsList.innerHTML = `<div class="text-red-300 text-sm">${e.message}</div>`;
    }
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return '';
  }

  async function createGroup(tId){
    const name = groupNameInput.value.trim();
    const studentId = studentIdInput.value.trim();
    if(!name){
      alert('Введите название группы');
      return;
    }
    const body = { name, teacher_id: tId };
    if(studentId) body.student_ids = [Number(studentId)];
    const headers = {
      'Content-Type':'application/json',
      'X-CSRFToken': getCookie('csrftoken')
    };
    const token = localStorage.getItem('access');
    if(token) headers['Authorization'] = `Bearer ${token}`;
    const resp = await fetch('/api/groups/', {
      method:'POST',
      headers,
      body: JSON.stringify(body),
      credentials: 'include'
    });
    if(!resp.ok){
      const txt = await resp.text();
      alert('Ошибка: ' + txt);
      return;
    }
    groupNameInput.value = '';
    studentIdInput.value = '';
    loadGroups(tId);
  }

  createGroupBtn?.addEventListener('click', ()=>{ if(teacherId) createGroup(teacherId); });

  loadTeacher();
</script>
{% endblock %}
